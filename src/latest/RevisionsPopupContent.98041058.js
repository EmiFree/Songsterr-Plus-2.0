var SubmitFormStates,ReportFormStates;import{_ as e,p as t,T as a,a as s,R as i,y as o,c as n,s as l,h as r}from"./preact.3d326435.js";import{O as c,cL as u,u as d,bE as m,f as p,Q as f,bF as _,R as v,U as h,cM as k,V as w,cN as g,ah as b,ai as C,h as N,cO as R,aj as y,ak as S,bu as I,cP as $,L as E,cc as D,cQ as x,bI as B,j as H}from"./index.c64a48b4.js";import{S as O,G as F}from"./UploadInstructions.042606bf.js";import{I as j}from"./Input.33ac2f73.js";import{A as A}from"./ActionButton.3cab06c5.js";import{_ as L}from"./UploadRevisionForm.module.7bd6e9b7.js";import{R as T,j as M}from"./user.0e209c5e.js";let content$1=c+" B9j34t",__default$4={content:c+" B9j34t"},warningStyles={...u,...__default$4},UploadRevisionForm=i=>{let{meta:o,actions:n}=i,{dispatch:l,device:r}=d("device"),c=e(),g=e(),[b,C]=t(!1),[N,R]=t(null),[y,S]=t(null),[I,$]=t(null),E=async(e,t,a,s)=>{C(!0),R(null);try{let i=_();v([{field:e,validator:h},{field:t,validator:i}]);let n={file:t.files[0],summary:e.value,songId:o.songId.toString(),force:a};await k(l,n,s),$(null)}catch(e){e instanceof w?(S(!0),$(e)):(S(!1),R(e))}C(!1)},D=a(e=>{e.preventDefault();let t=new m;return E(g.current,c.current,y,t.signal),t.abort.bind(t)},[g,c,y]),x=o.tracks&&o.tracks.length>2;return s("form",{noValidate:!0,className:L.form,onSubmit:D,action:""},s(f,{styles:u,error:N}),s("p",{className:L.motto,"aria-label":"motto"},"Download the latest revision from the list below, make your edits,",s("br",null),"save the result and upload it using the form below.",x&&s("span",{role:"warning"},s("br",null),"Please make sure to keep all the tracks in the resulting file.")),s(F,{id:"revisionFile",ref:c,name:"file",error:I||N,popup:!0,errorStyles:I?warningStyles:u}),s(O,{device:r,styles:L,mode:"revision"}),s(j,{ref:g,name:"summary",type:"textarea",error:N,placeholder:"Briefly explain your changes (fixed errors, replaces with whole new version, corrected tempo, etc)",styles:L,errorStyles:u,popup:!0}),s("div",{className:L.actions},s("a",{className:p.popupButtonLinkGreen,onClick:n.back},"Cancel"),s(A,{id:I?"submitRevisionButtonWarning":"submitRevisionButton",title:y?"Submit anyway":"Submit revision",processing:b})),s("p",{className:L.notice},"Once processing is complete, we'll send you an email notification,",s("br",null),"and the site will display the new revision."))},section$1="w31p8",current="w3261",currentText="w3dp",options="w3a5",reason="w31q",text="w3n5",textarea="w32aw",title$1="w3s9",notice="w3e7",actions$1="w31fb",__default$3={section:"w31p8",current:"w3261",currentText:"w3dp",options:"w3a5",reason:"w31q",text:"w3n5",textarea:"w32aw",title:"w3s9",notice:"w3e7",actions:"w31fb"},REVISION_REPORTS_STORAGE="revisionReports";function reducer(e,t){switch(t.type){case"enable":return{...e,form:!0};case"toggle":return{...e,reason:t.kind};case"submit":return{...e,processing:!0,error:null};case"success":return{...e,processing:!1,success:!0};case"failure":return{...e,processing:!1,error:t.error}}}function updateReportedCache(e){let t=b(REVISION_REPORTS_STORAGE)||[];t.push(e),C(REVISION_REPORTS_STORAGE,t)}let RevisionReportForm=i(t=>{let{meta:i,actions:n}=t,l=e(),{dispatch:r}=d(),[c,_]=o(reducer,{form:!1,processing:!1,error:null,reason:null,message:null,success:!1}),v=async(e,t,a,s)=>{_({type:"submit"});try{g(t,a);let i={songId:e.songId,revisionId:e.revisionId,kind:t,summary:a};await M(i,s),updateReportedCache(e.revisionId),_({type:"success"}),setTimeout(n.success,0),r("curiosity/event",{event:"Reported revision",Reason:T[t],Summary:a,"Song id":e.songId.toString()})}catch(e){_({type:"failure",error:e})}},h=a(e=>{e.preventDefault();let t=new m;return v(i,c.reason,l.current.value,t.signal),t.abort.bind(t)},[c,i]);return c.success?s("section",{className:__default$3.section,"data-section":"report"},s("p",null,"Your report has been sent."),s("p",{className:__default$3.notice},"We'll review your report as soon as possible. ",s("br",null),"And will roll back the revision in case of a problem."),s("div",{className:__default$3.actions},s("a",{className:p.popupButtonOrange,onClick:n.back},"OK"))):s("section",{className:__default$3.section,"data-section":"report"},s("form",{noValidate:!0,className:__default$3.form,onSubmit:h,action:""},s(f,{styles:u,error:c.error}),s("p",{className:__default$3.title},"Do you think that the new revision made the tab worse?",s("br",null),"If so, please tell us why:"),s("ul",{className:__default$3.options},Object.keys(T).map(e=>{let t={key:e,className:__default$3.reason,onClick:()=>_({type:"toggle",kind:e})};return s("li",t,s("input",{type:"radio",name:"reason",checked:c.reason===e,value:e}),s("label",{className:__default$3.text},T[e]))})),s(j,{ref:l,name:"comment",type:"textarea",error:c.error,placeholder:"Provide additional details on problematic tracks, measures, notes, etc.",styles:__default$3,errorStyles:u,popup:!0}),s("p",{className:__default$3.notice},"Note! Your remarks will be sent to the author of the revision."),s("div",{className:__default$3.actions},s("a",{className:p.popupButtonLinkOrange,onClick:n.back},"Cancel"),s(A,{id:"submitReportButton",title:"Report",processing:c.processing})),s("p",{className:__default$3.notice},"We'll review your report as soon as possible. ",s("br",null),"And will roll back the revision in case of a problem.")))}),DELIMITER="\x01",REGEX_URL=/(\b(https?):\/\/[-A-Z0-9+&@#/%?=~_|!:,.;]*[-A-Z0-9+&@#/%=~_|])/gi,splitByURL=e=>e.replace(REGEX_URL,e=>"\x01"+e+"\x01").split("\x01");function Linkify(e){let{children:t,styles:a}=e,i=splitByURL(t),o=i.map((e,t)=>{let i=REGEX_URL.test(e);return i?s("a",{className:a.link,key:`url${t}`,href:e,rel:"noopener noreferrer ugc",target:"_blank"},e):s(n,{key:`text${t}`},e)});return s("p",{className:a.message},o)}let item="C7k1rh",itemActive="C7k1rh C7kks",itemInvalid="C7k1rh C7k2yw",message="C7k2fj",itemInvalidActive="C7k1rh C7k2yw C7k22w",link$1="C7kwj",links="C7k182",person="C7k23d",block="C7k2fj C7kel",blockReasons="C7k1dv",__default$2={item:"C7k1rh",itemActive:"C7k1rh C7kks",itemInvalid:"C7k1rh C7k2yw",message:"C7k2fj",itemInvalidActive:"C7k1rh C7k2yw C7k22w",link:"C7kwj",links:"C7k182",person:"C7k23d",block:"C7k2fj C7kel",blockReasons:"C7k1dv"};function IconRevisionDelete(){return s("svg",{width:9,height:10,viewBox:"0 0 9 10"},s("path",{d:"m6.59 9.99-4.9.01C1.11 10 .64 9.55.64 8.99V2.18c0-.2.15-.38.4-.38h6.51c.22 0 .4.16.4.38v6.81c0 .56-.49 1-1.07 1h-.29ZM1.46 2.55v6.36c0 .13.12.25.28.25h5.09c.15 0 .28-.12.28-.25V2.55H1.46Z"}),s("path",{d:"M5.91 2.55h-3.4c-.21 0-.38-.16-.38-.37V1.12C2.13.5 2.65 0 3.27 0h1.85c.64 0 1.16.5 1.16 1.12v1.06c0 .21-.17.37-.37.37ZM2.97 1.8h2.48v-.59c0-.2-.18-.39-.39-.37H3.34c-.2-.02-.37.17-.37.37v.59Zm1.32 6.54c-.23 0-.42-.18-.42-.37V3.81c0-.2.19-.37.42-.37.22 0 .42.17.42.37v4.16c0 .19-.2.37-.42.37Zm-1.54 0c-.23 0-.41-.18-.41-.37V3.81c0-.2.18-.37.41-.37.24 0 .42.17.42.37v4.16c0 .19-.18.37-.42.37Zm3.09 0c-.24 0-.4-.18-.4-.37V3.81c0-.2.16-.37.4-.37.23 0 .42.17.42.37v4.16c0 .19-.19.37-.42.37Z"}),s("path",{d:"M8.17 2.61H.41C.17 2.61 0 2.4 0 2.2c0-.21.17-.41.41-.41h7.76c.24 0 .41.2.41.41 0 .2-.17.41-.41.41Z"}))}let wrapper="Boi34j",link="Boi1x6",linkDisabled="Boi32g",__default$1={wrapper:"Boi34j",link:"Boi1x6",linkDisabled:"Boi32g"},getConfirmation=e=>{let t=`You are about to delete your revision permanently. To confirm deletion, please ID for revision you want to delete "${e}" into the field below:`,a=window.prompt(t);return a===e.toString()||(window.alert("Confirmation string does not match artist and title."),!1)},RevisionItemDeleteLink=e=>{let{revisionId:a,songLink:i}=e,{dispatch:o}=d(),[n,l]=t(!1),r=async e=>{e.preventDefault();try{l(!0),getConfirmation(a)&&(await R(o,{revisionId:a}),o("navigate",i)),l(!1)}catch(e){l(!1)}};return s("a",{className:__default$1.link,onClick:r},!n&&s(IconRevisionDelete,null),n&&s(N,{width:10,height:10,fill:"#6ccd43"})," delete")};function IconRevisionView(){return s("svg",{width:15,height:8,viewBox:"0 0 15 8"},s("path",{d:"M8 2.9a1.1 1.1 0 0 0 0 2.2 1.1 1.1 0 0 0 0-2.2zm0 4a2.9 2.9 0 0 1 0-5.8 2.9 2.9 0 0 1 0 5.8zM14.5 3C13.2 2 10.9.3 8 .3S2.8 2 1.5 3c-.9.6-.9 1.4 0 2C2.8 6 5.1 7.7 8 7.7S13.2 6 14.5 5c.9-.6.9-1.4 0-2z"}))}function IconRevisionDownload(){return s("svg",{width:8,height:8,viewBox:"0 0 8 8"},s("path",{d:"M6 0H2v4H0l4 4L8 4H6V0z"}))}function IconRevisionReport(){return s("svg",{width:8,height:8,viewBox:"0 0 8 8"},s("path",{d:"M7.45 4.71 6.17 2.67 7.46.61c.02-.04.03-.1 0-.14A.139.139 0 0 0 7.34.4H1.88V.13c0-.07-.31-.13-.39-.13-.07 0-.41.06-.41.13v7.73c0 .08.36.13.43.13.08 0 .46-.04.46-.12V4.93h5.38c.07 0 .13-.06.13-.13 0-.03-.02-.06-.03-.09z"}))}function IconRevisionEdit(){return s("svg",{width:10,height:10,viewBox:"0 0 10 10"},s("path",{d:"m9.76 2.66-.53.47L7.21.97l.45-.44c.58-.58 1-.27 1.56.33.56.59 1.11 1.23.54 1.8Zm-.6 2.32v3.31c.01.8-.51 1.47-1.36 1.47H6.33c-1.79 0-4.5.01-4.92 0C.83 9.76 0 9.4 0 8.32V1.98C0 1.38.45.61 1.42.61h4.54v.81l-4.54.01c-.4-.01-.59.17-.59.55 0 .39 0 2.52.01 6.4-.01.37.18.56.58.56h6.36c.37.01.56-.2.56-.63s.01-1.54.01-3.33h.81ZM6.97 2.12l.25-.24-.47-.49-.25.23-3.15 3.03-.07.07-.02.08-.67 2.29-.17.59.59-.17 2.2-.62.08-.03.06-.06 3.16-3.02.24-.24-.47-.49-.25.23-3.08 2.96-1.07-1.13.01-.03 3.08-2.96Z"}))}let RevisionItemLinks=e=>{let{dispatch:t,user:a,meta:i,experiments:o}=d("user","meta","experiments"),{isCurrent:n,isLatest:l,isBaseRevision:r,isInvalid:c,reportAction:u,revision:m}=e,{revisionId:p,tracks:f}=m,_=i.songId.toString(),v=f?Math.min(f-1,i.partId):0,h=y(a,S.MANAGE_REVISIONS),k=o.download_without_sign_in?.segment==="on"||a?.isLoggedIn,w=I(i.current,v),g=I(i.current,v,p),C=(b(REVISION_REPORTS_STORAGE)||[]).includes(p),N=n&&l&&!c&&!r,R=a.profile&&a.profile.id===m.personId,D=new Date(m.createdAt).getTime()>new Date().getTime()-864e5,x=N&&!R&&!m.isBlocked,B=h||N&&R&&D,H=x&&s("a",{className:C?__default$1.linkDisabled:__default$1.link,onClick:C?void 0:u},s(IconRevisionReport,null),C?" reported":" report"),O=B&&s(RevisionItemDeleteLink,{revisionId:p,songLink:w}),F=h&&s("a",{className:__default$1.link,href:$("Revision",p),target:"_blank"},s(IconRevisionEdit,null)," edit"),j=!n&&s(E,{className:__default$1.link,to:g,"aria-label":"view",onClick:()=>t("curiosity/event",{event:"Clicked on View revision link","Song id":_})},s(IconRevisionView,null)," view"),A=k&&s("a",{className:__default$1.link,href:m.source,"aria-label":"download",download:!0,target:"_blank",onClick:()=>t("curiosity/event",{event:"Downloaded revision","Song id":_})},s(IconRevisionDownload,null)," download");return s("span",{className:__default$1.wrapper},j,H,F,O,A)},RevisionItem=e=>{let t;let{revision:a,isCurrent:i,isLatest:o,isInvalid:n,isBaseRevision:l,processing:r,locales:c,reportAction:u}=e,{revisionId:d,isBlocked:m}=a,p=D(new Date(a.createdAt),c);t=n||m?i?__default$2.itemInvalidActive:__default$2.itemInvalid:i?__default$2.itemActive:__default$2.item;let f=a.isBlocked&&a.reports.length>0&&s("div",{className:__default$2.block},"Block reasons:",s("ul",{className:__default$2.blockReasons},a.reports.map(e=>s("li",{},`${x.get(e.kind)}${e.summary?`: ${e.summary}`:""}`))));return s("li",{key:d,className:t},s(Linkify,{styles:__default$2},a.description),f,s("p",{className:__default$2.links},`${p} \u2013 by `,s("span",{className:__default$2.person},a.person),!r&&s(RevisionItemLinks,{revision:a,isCurrent:i,isLatest:o,isBaseRevision:l,isInvalid:n,reportAction:u})))},scroller="Cca1wi",spinner="Cca13w",title="Ccahc",content="Cca1mk",section="Cca34p",sectionForm="Cca1z3",actions="Ccame",motto="Cca1lf",subMotto="Cca1lf Cca1gp",auth="Cca2yf",authReport="Cca2yf Cca2uj",list="Cca1p3",__default={scroller:"Cca1wi",spinner:"Cca13w",title:"Ccahc",content:"Cca1mk",section:"Cca34p",sectionForm:"Cca1z3",actions:"Ccame",motto:"Cca1lf",subMotto:"Cca1lf Cca1gp",auth:"Cca2yf",authReport:"Cca2yf Cca2uj",list:"Cca1p3"},DEFAULT_POPUP_OFFSET=38,TITLE_HEIGHT=107;!function(e){e[e.HIDDEN=0]="HIDDEN",e[e.SHOWN=1]="SHOWN"}(SubmitFormStates||(SubmitFormStates={})),function(e){e[e.HIDDEN=0]="HIDDEN",e[e.SHOWN=1]="SHOWN",e[e.SUCCESS=2]="SUCCESS"}(ReportFormStates||(ReportFormStates={}));let calculateBaseHeight=e=>({height:e-76}),RevisionsPopupContent=i=>{let{style:o,setStyle:c}=i,{dispatch:u,user:m,revisions:f,uploads:_,meta:v,device:h,screen:k,experiments:w}=d("user","revisions","uploads","meta","device","screen","experiments"),{isLoggedIn:g}=m,{isLoading:b}=f,{revision:C,revisionError:R,revisionSubmitted:y}=_,[S,I]=t(SubmitFormStates.HIDDEN),[$,D]=t(ReportFormStates.HIDDEN),x=e(),O=e(),F=$?"Report revision":"Revisions";l(()=>{let e=O.current.scrollHeight,t=calculateBaseHeight(k.viewport.height).height,a={...o,height:Math.min(e+107,t)};o.height!==a.height&&c(a)},[k,O,f,C,_,$,S]),r(()=>{!1===m.isLoggedIn&&w.download_without_sign_in?.status==="pending"&&u("experiments/activate",{experimentName:"download_without_sign_in",payload:{"Song id":v.songId.toString()}})},[]);let j=g&&C&&!R,A=g&&C&&C.songId!==v.songId,L=A?`${C.artist} ΓÇô ${C.title}`:"",T={success:()=>D(ReportFormStates.SUCCESS),back:()=>D(ReportFormStates.HIDDEN)},M={back:()=>I(SubmitFormStates.HIDDEN)},V=s("section",{className:__default.section,"data-section":"welcome"},s("p",{className:__default.motto},"Have a better tab for this song?"),s("p",{className:__default.motto},"Care to fix the current tab?"),s("p",{className:__default.subMotto},"Submit your corrections for everyone to enjoy!"),s("div",{className:__default.auth,"aria-label":"auth"},"Please ",s(E,{"data-link":"signin",to:"/a/wa/signin"},"sign up")," for free to submit a new revision.")),U=s("section",{className:__default.sectionForm,"data-section":"submit"},s("p",{className:__default.motto},"Have a better tab for this song?"),s("p",{className:__default.motto},"Care to fix the current tab?"),s("p",{className:__default.subMotto},"Submit your corrections for everyone to enjoy!"),s("div",{className:__default.actions},s("a",{id:"submit-revision-button",className:p.popupButtonGreen,onClick:()=>I(SubmitFormStates.SHOWN)},"Submit a new revision"))),P=s("section",{className:__default.sectionForm,"data-section":"submit"},s(UploadRevisionForm,{meta:v.current,actions:M})),Z=s("section",{className:__default.section,"data-section":"duplicate"},s("p",{className:__default.motto,"aria-label":"motto"},"Submitted version already exists on Songsterr."),!A&&s("p",{className:__default.subMotto,"aria-label":"info"},"Uploaded file looks exactly like the latest version of this song."),A&&s("div",null,s("p",{className:__default.subMotto,"aria-label":"info"},"Uploaded file looks like a duplicate of ",s("br",null),s(E,{to:B(C),"data-link":"duplicate"},L)))),G=s("section",{className:__default.section,"data-section":"success"},s("div",null,s("p",{className:__default.motto},"Thanks for contributing to Songsterr!"),s("p",{className:__default.subMotto},"We are processing the file and will redirect",s("br",null),"to a new revision as soon as possible."),s("div",null,s(N,{fill:"#fefefe",width:30,height:30})))),W=a((e,t)=>1===e.length||0!==t?{reportAction:null}:{reportAction:()=>{x.current&&(x.current.scrollTop=0),$||D(ReportFormStates.SHOWN),u("curiosity/event",{event:"Clicked on Report link"})}},[x,$]),z=f.revisions?.length-1,X=s("section",{className:__default.sectionContent,"data-section":"revisions"},s("ul",{className:__default.list},f.revisions&&v.current&&f.revisions.map((e,t)=>s(RevisionItem,{revision:e,isCurrent:v.current.revisionId===e.revisionId,isLatest:0===t,isBaseRevision:t===z,isInvalid:!e.tracks,key:e.revisionId,locales:h.locale?[h.locale]:void 0,processing:y,...W(f.revisions,t)})))),Y=!g&&!$,q=g&&!j&&!$&&!S,Q=g&&!j&&!$&&!!S,K=j&&!$&&!y,J=j&&!$&&y;return s(n,{},s("h3",{className:__default.title},F),s("div",{className:__default.scroller,ref:x},s("div",{className:__default.content,ref:O},Y&&V,q&&U,Q&&P,K&&Z,J&&G,g&&!!$&&s(RevisionReportForm,{meta:v.current,actions:T}),!g&&!!$&&s("section",{className:__default.section,"data-section":"welcome"},s("div",{className:__default.authReport,"aria-label":"auth"},"Please ",s(E,{"data-link":"signin",to:"/a/wa/signin"},"sign up")," for free to report issues."),s("a",{className:p.popupButtonLinkOrange,onClick:()=>D(0)},"Back to revisions")),b&&!$&&s("div",{className:__default.spinner},s(N,{className:H.revisions,width:25,height:24,fill:"#f7f6ee"})),!b&&!$&&X)))};export{RevisionsPopupContent as default};
