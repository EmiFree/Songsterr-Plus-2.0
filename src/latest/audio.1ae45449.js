!function(e){e[e.V1=1]="V1",e[e.V2=2]="V2",e[e.V4=4]="V4",e[e.MASTER=2]="MASTER",e[e.DEV=777]="DEV"}(AudioVersion||(AudioVersion={})),function(e){e[e.TOO_LONG=228]="TOO_LONG",e[e.MIDI_FAILED=229]="MIDI_FAILED",e[e.NOT_FOUND=404]="NOT_FOUND",e[e.UNKNOWN=500]="UNKNOWN"}(AudioRenderError||(AudioRenderError={}));let audioVersionInfos=[{displayName:"V1",version:AudioVersion.V1,bucket:"audio",bucketDomains:["audio1","audio2","audio3"],audioHashPropertyName:"audio"},{displayName:"V2",version:AudioVersion.V2,versionLegacy:"audioV2",bucket:"audio3",bucketDomains:["audio31","audio32","audio33"],audioHashPropertyName:"audioV2",audioErrorPropertyName:"audioV2Error",midiHashPropertyName:"audioV2Midi"},{displayName:"V4",version:AudioVersion.V4,bucket:"audio4",bucketDomains:["audio4-1","audio4-2","audio4-3"],audioHashPropertyName:"audioV4",audioErrorPropertyName:"audioV4Error",midiHashPropertyName:"audioV4Midi"},{displayName:"Dev",version:AudioVersion.DEV,versionLegacy:"next",bucket:"audio2",bucketDomains:["audio2"],audioHashPropertyName:"nextAudio",midiHashPropertyName:"nextMidi"}],audioVersionInfosMap=new Map;function getMetaAudioVersions(e){return audioVersionInfos.filter(t=>!!e[t.audioHashPropertyName]).map(e=>e.version)}function getMetaMidiHash(e,t){return t===AudioVersion.V2?e.audioV2Midi||null:t===AudioVersion.V4?e.audioV4Midi||null:t===AudioVersion.DEV&&e.nextMidi||null}function getMetaAudioInfo(e,t){let r=getAudioVersionInfo(t),i=e[r.audioHashPropertyName],a=r.audioErrorPropertyName?e[r.audioErrorPropertyName]:null,o=getMetaMidiHash(e,t);return{version:t,versionInfo:r,audio:i,audioError:a||void 0,midi:o||void 0}}function getLatestMVTag(e){return e===AudioVersion.V2?2:3}function getLatestAVTag(e){switch(e){case AudioVersion.V2:return 2;case AudioVersion.V4:return 4;case AudioVersion.DEV:return 3}throw Error(`Illegal argument ${e}`)}audioVersionInfos.forEach(e=>audioVersionInfosMap.set(e.version,e));class AudioVersionTag{numericVersion=0;payload="";constructor(e,t){this.numericVersion=e,this.payload=t}encode(){return AudioVersionTag.encode(this)}static getLatestAVTag(e){return getLatestAVTag(e)}static getLatestMVTag(e){return getLatestMVTag(e)}static encode(e){return`v${e.numericVersion}-${e.payload}`}static decode(e){if(!/^v\d+-/.test(e))return null;let[t,r]=e.split("-");return new AudioVersionTag(+t.substring(1),r)}}function getAudioVersionInfo(e){let t=audioVersionInfosMap.get(e);if(t)return t;throw Error(`Unable to get audio version info for version ${e}`)}class MetaJsonExtensions{has(e,t){return getMetaAudioVersions(e).includes(t)}getAll(e){return getMetaAudioVersions(e)}get(e,t){return getMetaAudioInfo(e,t)}getMVTagForEnv(e,t){let r=getMetaAudioInfo(e,t),i=r.midi;return i?AudioVersionTag.decode(i):null}getAVTagForEnv(e,t){let r=getMetaAudioInfo(e,t),i=r.audio;return i?AudioVersionTag.decode(i):null}hasLatestAVTag(e,t){let r=this.getAVTagForEnv(e,t);return null!=r&&r.numericVersion>=getLatestAVTag(t)}hasLatestMVTag(e,t){let r=this.getMVTagForEnv(e,t);return null!=r&&r.numericVersion>=getLatestMVTag(t)}hasLatestSound(e,t){let r=this.getAVTagForEnv(e,t);if(null==r)return!1;let i=getLatestMVTag(t),a=getLatestAVTag(t),o=this.getMVTagForEnv(e,t);return null!=o?r.numericVersion>=a&&o.numericVersion>=i:r.numericVersion>=a}}let MetaAudio=new MetaJsonExtensions;function getApiUrl(e){return e}!function(e){e.ADMINISTRATE="administrate",e.MANAGE_SONGS="manage.songs",e.MANAGE_REVISIONS="manage.revisions",e.UPLOAD_ALL_FILES="upload.all.files",e.USE_ADMIN_TOOLS="use.admin.tools",e.USE_TAB_EDITOR="use.tab.editor",e.USE_VIDEO_SYNCHRONISATION="use.video.synchronisation"}(UserPermission||(UserPermission={})),function(e){e.FREE="free",e.PLUS="plus",e.BETA="beta",e.BASIC="basic"}(UserPlan||(UserPlan={})),function(e){e.NONE="none",e.LIFETIME="lifetime"}(AndroidLicense||(AndroidLicense={})),function(e){e.BRAINTREE="braintree",e.APP_STORE="appstore",e.GOOGLE_PLAY="googleplay",e.COUPON="coupon",e.MANUAL="manual",e.LEGACY_PAYPAL="paypal"}(SubscriptionType||(SubscriptionType={})),function(e){e.ACTIVE="active",e.CANCELED="canceled",e.EXPIRED="expired",e.OUTDATED="outdated"}(SubscriptionStatus||(SubscriptionStatus={})),function(e){e.ERRORS="errors",e.TRACKS="tracks",e.GLITCHES="glitches",e.VERSION="version",e.UNCLEAR="unclear",e.OTHER="other"}(REPORT_REASON||(REPORT_REASON={})),REPORT_REASON.ERRORS,REPORT_REASON.TRACKS,REPORT_REASON.GLITCHES,REPORT_REASON.VERSION,REPORT_REASON.UNCLEAR,REPORT_REASON.OTHER;class ValidationError extends Error{constructor(e,t,...r){super(...r),Error.captureStackTrace&&Error.captureStackTrace(this,ValidationError),this.name="ValidationError",this.reasons=e,this.message=t||"Form validation failed."}}class ValidationWarning extends ValidationError{constructor(e,t,...r){super(e,t,...r),Error.captureStackTrace&&Error.captureStackTrace(this,ValidationWarning),this.name="ValidationWarning"}}class FraudError extends Error{constructor(...e){super(...e),Error.captureStackTrace&&Error.captureStackTrace(this,FraudError),this.name="FraudError",this.message="Email verification failed."}}class RestrainError extends Error{constructor(e,...t){super(...t),Error.captureStackTrace&&Error.captureStackTrace(this,FraudError),this.name="RestrainError",this.action=e,this.message="Your actions appear suspicious."}}class FetchError extends Error{constructor(...e){super(...e),Error.captureStackTrace&&Error.captureStackTrace(this,FetchError),this.name="FetchError",this.message="Network error occurred. Please try again later."}}class NetworkError extends Error{constructor(e,t,...r){super(...r),Error.captureStackTrace&&Error.captureStackTrace(this,NetworkError),this.name="NetworkError",this.status=e,this.message=`Network error occurred (${e}). Please try again later.`,"undefined"!=typeof navigator&&(this.onLine=navigator&&navigator.onLine)}}function allowedByLicense(e,t){return!e||"AllCountries"!==e.restriction&&e.restriction!==t}async function getJson(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;r=r||{method:"get",credentials:"include"},t={...t,Accept:"application/json","Content-Type":"application/json"};try{return await fetch(e,{...r,headers:t})}catch(e){throw new FetchError}}async function postJson(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;i=i||{method:"post",credentials:"include"},r={...r,Accept:"application/json","Content-Type":"application/json"};let a=JSON.stringify(t);try{return await fetch(e,{...i,headers:r,body:a})}catch(e){throw new FetchError}}function checkStatusOk(e){if(!e.ok)throw new NetworkError(e.status,e.statusText)}async function checkRecaptchaStatus(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t=t||await e.json();let r=412===e.status&&"reCAPTCHA Validation Failed"===t.message,i=400===e.status&&"reCAPTCHA Validation Failed."===t.message;if(r||i)throw new ValidationError({__all__:"Please wait for reCAPTCHA logo to appear"},t.message)}async function checkStatusRestrained(e,t){if(429===e.status)throw new RestrainError(t)}async function checkStatusUnauthorized(e,t){if(403===e.status){let r=await e.json(),i=r.message||t;throw new ValidationError({__all__:i},i)}}async function checkStatusUnprocessable(e){if(422===e.status){let t=await e.json();throw new ValidationError(t.message||t.data||t)}}async function checkAuthRequestStatus(e){if(!e.ok){let t=await e.json(),r=t.message||t,i=t.reasons||{__all__:r};if(await checkRecaptchaStatus(e,t),422===e.status&&"You have incorrect email."===r)throw new FraudError;throw new ValidationError(i,r)}}async function checkUploadUnprocessable(e){if([400,422,423].includes(+e.status)){let t=await e.json();if(423===e.status)throw new ValidationWarning(t.reasons);throw new ValidationError(t.reasons||t)}}async function checkUploadStatus(e){if(!e.ok&&409!==e.status)throw Error("Oops, something went wrong. Please try again later")}async function apiDeleteTab(e,t){let r=getApiUrl(`/api/song/${e.songId}`),i=await fetch(r,{method:"delete",credentials:"include",signal:t});return t&&t.aborted?{success:!1}:(checkStatusOk(i),await checkStatusUnprocessable(i),checkStatusUnauthorized(i,"Forbidden"),{success:!!i.ok})}async function apiUpdateSound(e,t,r){let i=getApiUrl("/api/sound/update"),a=await postJson(i,{revisionId:e,version:t});r&&r.aborted||checkStatusOk(a)}async function apiGenerateSound(e,t,r){let i=getApiUrl("/api/sound/generate"),a=await postJson(i,{revisionId:e,version:t});r&&r.aborted||checkStatusOk(a)}let animationAvailable="undefined"!=typeof window&&!!window.requestAnimationFrame,getFileSpeed=e=>e<100?50:100;function get(e){try{return JSON.parse(window.localStorage.getItem(e))}catch(e){return null}}function set(e,t){try{t?window.localStorage.setItem(e,JSON.stringify(t)):window.localStorage.removeItem(e)}catch(e){}}var AudioVersion,AudioRenderError,UserPermission,UserPlan,AndroidLicense,SubscriptionType,SubscriptionStatus,REPORT_REASON,localStorage={get,set};let now=window.performance&&window.performance.now?window.performance.now.bind(window.performance):Date.now;function debounce(e,t){let r;var i=this;return function(){for(var a=arguments.length,o=Array(a),n=0;n<a;n++)o[n]=arguments[n];let s=()=>e.apply(i,o);clearTimeout(r),r=setTimeout(s,t)}}function throttle(e,t){let r=!1;return i=>{r||(e(i),r=!0,setTimeout(()=>{r=!1},t))}}let EVENTS=["scroll","keydown","click","mousemove","mousedown"];class UserInactivityTracker{constructor(){this.hasFirstActivity=!1,this.reset(),this.engage(),this.trackFirstActivity()}engage(){for(let e of EVENTS)window.addEventListener(e,this.trackActivity)}disengage(){for(let e of EVENTS)window.removeEventListener(e,this.trackActivity)}reset(){this.setIsActive(!1)}trackFirstActivity(){EVENTS.forEach(e=>window.addEventListener(e,()=>{this.hasFirstActivity=!0},{once:!0}))}trackActivity=throttle(()=>{this.lastActivityTimestampMs=now()},200);setIsActive(e){!this.isActive&&e?this.disengage():this.isActive&&!e&&this.engage(),this.lastActivityTimestampMs=now(),this.isActive=e}getTimeSinceLastActivity(){return this.isActive?0:Math.round((now()-this.lastActivityTimestampMs)/6e4)}}let userInactivityTracker=new UserInactivityTracker,FILE_PREFIX_MAP={solo:"s",focus:"f",mute:"m"},UPDATE_SOUND_V4_QUEUE_KEY="hasUpdatedSoundV4";function getDefaultAudioVersion(e,t){let r=t.new_sound?.segment==="drop",i=t.sound_v4?.segment==="drop";return i?AudioVersion.V2:r?AudioVersion.V1:AudioVersion.V4}async function generateAudioV4OnceAsync(e){try{let t="hasUpdatedSoundV4",r=get(t)||[];if(r.includes(e.revisionId))return;let i=e.revisionId;set(t,[...r,i]),await apiUpdateSound(e.revisionId,AudioVersion.V4)}catch(e){console.warn("error triggering audio update request (v4)")}}async function loadAudio(e,t,r,i,a){let o=e.get(),n=o.meta.current;if(!n)return;let{type:s,audio:u,forcedVersion:c}=o.player,d=getFileSpeed(o.player.speed),l=!!(u?.context&&window&&window.Worker),A=getDefaultAudioVersion(o.device,o.experiments);if(a||c?A=a||c:MetaAudio.has(n,A)||(A=AudioVersion.MASTER),!MetaAudio.has(n,A)){let e=MetaAudio.getAll(n);A=e[e.length-1]||AudioVersion.MASTER}let E=getAudioVersionInfo(A),g=n[E.audioHashPropertyName];if(u&&g&&l&&animationAvailable){let a=`${t}/${i}/${g}/${d}/${FILE_PREFIX_MAP[s]}/${r}.opus`;e.dispatch("player/open",{url:a,version:A})}}let module=e=>{e.on("curiosity/vpt10",e=>{if("bot"===e.device.type||e.isTestMode)return;let t=e.meta?.current;!(!t||MetaAudio.has(t,AudioVersion.V4))&&(userInactivityTracker.getTimeSinceLastActivity()>=5||generateAudioV4OnceAsync(t))}),e.on("meta/load:done",(t,r)=>{let{songId:i,partId:a,current:o}=r;if(allowedByLicense(o,t.device.country)&&(loadAudio(e,i,a,o.revisionId),"bot"===t.device.type||t.isTestMode))return})};export{AudioVersion as A,AudioRenderError as B,animationAvailable as C,now as D,checkStatusUnauthorized as E,checkStatusUnprocessable as F,checkRecaptchaStatus as G,AndroidLicense as H,FetchError as I,FraudError as J,MetaAudio as M,NetworkError as N,RestrainError as R,SubscriptionType as S,UserPermission as U,ValidationError as V,UserPlan as a,allowedByLicense as b,checkStatusOk as c,get as d,getJson as e,checkAuthRequestStatus as f,getApiUrl as g,checkStatusRestrained as h,checkUploadUnprocessable as i,checkUploadStatus as j,apiDeleteTab as k,loadAudio as l,apiGenerateSound as m,apiUpdateSound as n,localStorage as o,postJson as p,getAudioVersionInfo as q,module as r,set as s,AudioVersionTag as t,userInactivityTracker as u,getDefaultAudioVersion as v,throttle as w,getFileSpeed as x,debounce as y,ValidationWarning as z};