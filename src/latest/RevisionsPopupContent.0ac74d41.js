var SubmitFormStates,ReportFormStates;import{_ as e,p as t,T as a,a as s,R as i,y as o,c as n,s as l}from"./preact.bf58aca5.js";import{O as r,cN as c,u as u,aj as d,ak as m,bH as p,f as f,Q as _,bI as v,R as k,U as h,cO as b,V as g,cP as C,ah as w,ai as N,bx as R,ce as y,cQ as S,cR as I,L as $,bL as E,h as L,j as x}from"./index.e8b15340.js";import{C as F,S as O,F as A}from"./UploadInstructions.963b6683.js";import{I as D}from"./Input.bba300bf.js";import{A as B}from"./ActionButton.45f3bd1f.js";import{_ as H}from"./UploadRevisionForm.module.d3c3c9f7.js";import{R as j,j as T}from"./user.b43c7f25.js";let content$1=r+" B9j34t",__default$3={content:r+" B9j34t"},warningStyles={...c,...__default$3},UploadRevisionForm=i=>{let{meta:o,actions:n}=i,{dispatch:l,user:r,device:C,experiments:w}=u("user","device","experiments"),N=e(),R=e();w.gpif_support?.status==="pending"&&l("experiments/activate",{experimentName:"gpif_support"});let y=w.gpif_support?.segment==="on",S=d(r,m.UPLOAD_ALL_FILES)||y,I=S?".gp3, .gp4, .gp5, .gpx, .gp":".gp3, .gp4, .gp5",$=y?"Choose your Guitar Pro file":"Choose your .gp5 file",[E,L]=t(!1),[x,j]=t(null),[T,U]=t(null),[M,P]=t(null),V=async(e,t,a,s)=>{L(!0),j(null);try{let i=v(S);k([{field:e,validator:h},{field:t,validator:i}]);let n={file:t.files[0],summary:e.value,songId:o.songId.toString(),force:a};await b(l,n,s),P(null)}catch(r){r instanceof g?(U(!0),P(r)):(U(!1),j(r))}L(!1)},G=a(e=>{e.preventDefault();let t=new p;return V(R.current,N.current,T,t.signal),t.abort.bind(t)},[R,N,T]),W=o.tracks&&o.tracks.length>2;return s("form",{noValidate:!0,className:H.form,onSubmit:G,action:""},s(_,{styles:c,error:x}),s("p",{className:H.motto,"aria-label":"motto"},"Download the latest revision from the list below, make your edits,",s("br",null),"save the result and upload it using the form below.",W&&s("span",{role:"warning"},s("br",null),"Please make sure to keep all the tracks in the resulting file.")),s(A,{id:"revisionFile",accept:I,label:"Upload your .gp5 file",ref:N,name:"file",error:M||x,buttonLabel:$,popup:!0,errorStyles:M?warningStyles:c,isDropFileAvailable:!0,isNewFormats:S}),s(O,{device:C,styles:H,mode:"revision"}),s(F,{device:C,styles:H,mode:"revision",isTestSegment:y}),s(D,{ref:R,name:"summary",type:"textarea",error:x,placeholder:"Briefly explain your changes (fixed errors, replaces with whole new version, corrected tempo, etc)",styles:H,errorStyles:c,popup:!0}),s("div",{className:H.actions},s("a",{className:f.popupButtonLinkGreen,onClick:n.back},"Cancel"),s(B,{id:M?"submitRevisionButtonWarning":"submitRevisionButton",title:T?"Submit anyway":"Submit revision",processing:E})),s("p",{className:H.notice},"Once processing is complete, we'll send you an email notification,",s("br",null),"and the site will display the new revision."))},section$1="w31p8",current="w3261",currentText="w3dp",options="w3a5",reason="w31q",text="w3n5",textarea="w32aw",title$1="w3s9",notice="w3e7",actions$1="w31fb",__default$2={section:"w31p8",current:"w3261",currentText:"w3dp",options:"w3a5",reason:"w31q",text:"w3n5",textarea:"w32aw",title:"w3s9",notice:"w3e7",actions:"w31fb"},REVISION_REPORTS_STORAGE="revisionReports";function reducer(e,t){switch(t.type){case"enable":return{...e,form:!0};case"toggle":return{...e,reason:t.kind};case"submit":return{...e,processing:!0,error:null};case"success":return{...e,processing:!1,success:!0};case"failure":return{...e,processing:!1,error:t.error}}}function hasBeenReported(e){return(w(REVISION_REPORTS_STORAGE)||[]).includes(e)}function updateReportedCache(e){let t=w(REVISION_REPORTS_STORAGE)||[];t.push(e),N(REVISION_REPORTS_STORAGE,t)}let RevisionReportForm=i(t=>{let{meta:i,actions:n}=t,l=e(),{dispatch:r}=u(),[d,m]=o(reducer,{form:!1,processing:!1,error:null,reason:null,message:null,success:!1}),v=async(e,t,a,s)=>{m({type:"submit"});try{C(t,a);let i={songId:e.songId,revisionId:e.revisionId,kind:t,summary:a};await T(i,s),updateReportedCache(e.revisionId),m({type:"success"}),setTimeout(n.success,0),r("curiosity/event",{event:"Reported revision",Reason:j[t],Summary:a})}catch(o){m({type:"failure",error:o})}},k=a(e=>{e.preventDefault();let t=new p;return v(i,d.reason,l.current.value,t.signal),t.abort.bind(t)},[d,i]);return d.success?s("section",{className:__default$2.section,"data-section":"report"},s("p",null,"Your report has been sent."),s("p",{className:__default$2.notes},"We'll review your report as soon as possible. ",s("br",null),"And will roll back the revision in case of a problem."),s("div",{className:__default$2.actions},s("a",{className:f.popupButtonOrange,onClick:n.back},"OK"))):s("section",{className:__default$2.section,"data-section":"report"},s("form",{noValidate:!0,className:__default$2.form,onSubmit:k,action:""},s(_,{styles:c,error:d.error}),s("p",{className:__default$2.title},"Do you think that the new revision made the tab worse?",s("br",null),"If so, please tell us why:"),s("ul",{className:__default$2.options},Object.keys(j).map(e=>{let t={key:e,className:__default$2.reason,onClick:()=>m({type:"toggle",kind:e})};return s("li",t,s("input",{type:"radio",name:"reason",checked:d.reason===e,value:e}),s("label",{className:__default$2.text},j[e]))})),s(D,{ref:l,name:"comment",type:"textarea",error:d.error,placeholder:"Provide additional details on problematic tracks, measures, notes, etc.",styles:__default$2,errorStyles:c,popup:!0}),s("p",{className:__default$2.notes},"Note! Your remarks will be sent to the author of the revision."),s("div",{className:__default$2.actions},s("a",{className:f.popupButtonLinkOrange,onClick:n.back},"Cancel"),s(B,{id:"submitReportButton",title:"Report",processing:d.processing})),s("p",{className:__default$2.notes},"We'll review your report as soon as possible. ",s("br",null),"And will roll back the revision in case of a problem.")))}),DELIMITER="\x01",REGEX_URL=/(\b(https?):\/\/[-A-Z0-9+&@#/%?=~_|!:,.;]*[-A-Z0-9+&@#/%=~_|])/gi,splitByURL=e=>e.replace(REGEX_URL,e=>"\x01"+e+"\x01").split("\x01");function Linkify(e){let{children:t,styles:a}=e,i=splitByURL(t),o=i.map((e,t)=>{let i=REGEX_URL.test(e);return i?s("a",{className:a.link,key:`url${t}`,href:e,rel:"noopener noreferrer ugc",target:"_blank"},e):s(n,{key:`text${t}`},e)});return s("p",{className:a.message},o)}function IconRevisionView(){return s("svg",{width:15,height:8,viewBox:"0 0 15 8"},s("path",{d:"M8 2.9a1.1 1.1 0 0 0 0 2.2 1.1 1.1 0 0 0 0-2.2zm0 4a2.9 2.9 0 0 1 0-5.8 2.9 2.9 0 0 1 0 5.8zM14.5 3C13.2 2 10.9.3 8 .3S2.8 2 1.5 3c-.9.6-.9 1.4 0 2C2.8 6 5.1 7.7 8 7.7S13.2 6 14.5 5c.9-.6.9-1.4 0-2z"}))}function IconRevisionReport(){return s("svg",{width:8,height:8,viewBox:"0 0 8 8"},s("path",{d:"M7.45 4.71 6.17 2.67 7.46.61c.02-.04.03-.1 0-.14A.139.139 0 0 0 7.34.4H1.88V.13c0-.07-.31-.13-.39-.13-.07 0-.41.06-.41.13v7.73c0 .08.36.13.43.13.08 0 .46-.04.46-.12V4.93h5.38c.07 0 .13-.06.13-.13 0-.03-.02-.06-.03-.09z"}))}function IconRevisionDownload(){return s("svg",{width:8,height:8,viewBox:"0 0 8 8"},s("path",{d:"M6 0H2v4H0l4 4L8 4H6V0z"}))}let item="C7k1rh",itemActive="C7k1rh C7kks",itemInvalid="C7k1rh C7k2yw",message="C7k2fj",itemInvalidActive="C7k1rh C7k2yw C7k22w",meta="C7krn",person="C7k23d",adminLinks="C7kl6",adminLink="C7k7o",metaLinks="C7k2a1",link="C7kwj",actionLink="C7k7t",disabledLink="C7k29n",linkActive="C7kv8",__default$1={item:"C7k1rh",itemActive:"C7k1rh C7kks",itemInvalid:"C7k1rh C7k2yw",message:"C7k2fj",itemInvalidActive:"C7k1rh C7k2yw C7k22w",meta:"C7krn",person:"C7k23d",adminLinks:"C7kl6",adminLink:"C7k7o",metaLinks:"C7k2a1",link:"C7kwj",actionLink:"C7k7t",disabledLink:"C7k29n",linkActive:"C7kv8"},RevisionItem=e=>{let t;let{revision:a,meta:i,partId:o,processing:n,locales:l,reportAction:r}=e,{dispatch:c}=u(),d=!a.tracks,m=a.revisionId===i.revisionId,p=a.tracks?Math.min(a.tracks-1,o):0,f=R(i,p,a.revisionId),_=y(new Date(a.date),l),v=hasBeenReported(a.revisionId),k=S("deleteRevision",a.revisionId),h=S("editRevision",a.revisionId),b=I("Revision",a.revisionId),g=e.canManageRevisions&&s("span",{className:__default$1.adminLinks},s("a",{className:__default$1.adminLink,href:h,target:"_blank"},"edit"),s("a",{className:__default$1.adminLink,href:k,target:"_blank"},"delete"),a.isBlocked&&s("a",{className:__default$1.adminLink,href:b},"unblock")),C={className:__default$1.actionLink,to:f,"aria-label":"action",onClick:()=>c("curiosity/event",{event:"Clicked on View revision link"})},w={className:__default$1.linkActive,href:a.source,"aria-label":"download",download:!0,target:"_blank"},N=s("span",{className:__default$1.metaLinks},!m&&s($,C,s(IconRevisionView,null)," view"),m&&r&&s("a",{className:v?__default$1.disabledLink:__default$1.linkActive,onClick:v?null:r},s(IconRevisionReport,null),v?" reported":" report"),e.canDownloadRevisions&&s("a",w,s(IconRevisionDownload,null)," download"));return t=d||a.isBlocked?m?__default$1.itemInvalidActive:__default$1.itemInvalid:m?__default$1.itemActive:__default$1.item,s("li",{key:a.revisionId,className:t},s(Linkify,{styles:__default$1},`${a.isBlocked?"Blocked: ":""}${a.summary}`),s("p",{className:__default$1.meta},`${_} \u2013 by `,s("span",{className:__default$1.person},a.person),g,!n&&N))},scroller="Cca1wi",spinner="Cca13w",title="Ccahc",content="Cca1mk",section="Cca34p",sectionForm="Cca1z3",actions="Ccame",motto="Cca1lf",subMotto="Cca1lf Cca1gp",auth="Cca2yf",authReport="Cca2yf Cca2uj",list="Cca1p3",__default={scroller:"Cca1wi",spinner:"Cca13w",title:"Ccahc",content:"Cca1mk",section:"Cca34p",sectionForm:"Cca1z3",actions:"Ccame",motto:"Cca1lf",subMotto:"Cca1lf Cca1gp",auth:"Cca2yf",authReport:"Cca2yf Cca2uj",list:"Cca1p3"},DEFAULT_POPUP_OFFSET=38,TITLE_HEIGHT=107;!function(e){e[e.HIDDEN=0]="HIDDEN",e[e.SHOWN=1]="SHOWN"}(SubmitFormStates||(SubmitFormStates={})),function(e){e[e.HIDDEN=0]="HIDDEN",e[e.SHOWN=1]="SHOWN",e[e.SUCCESS=2]="SUCCESS"}(ReportFormStates||(ReportFormStates={}));let calculateBaseHeight=e=>({height:e-76}),RevisionsPopupContent=i=>{let{style:o,setStyle:r}=i,{dispatch:c,user:p,revisions:_,uploads:v,meta:k,device:h,screen:b}=u("user","revisions","uploads","meta","device","screen"),{isLoggedIn:g}=p,{isLoading:C}=_,{revision:w,revisionError:N,revisionSubmitted:R}=v,[y,S]=t(SubmitFormStates.HIDDEN),[I,F]=t(ReportFormStates.HIDDEN),O=e(),A=e(),D=I?"Report revision":"Revisions";l(()=>{let e=A.current.scrollHeight,t=calculateBaseHeight(b.viewport.height).height,a={...o,height:Math.min(e+107,t)};o.height!==a.height&&r(a)},[b,A,_,w,v,I,y]);let B=g&&w&&!N,H=g&&w&&w.songId!==k.songId,j=H?`${w.artist} ΓÇô ${w.title}`:"",T={success:()=>F(ReportFormStates.SUCCESS),back:()=>F(ReportFormStates.HIDDEN)},U={back:()=>S(SubmitFormStates.HIDDEN)},M=s("section",{className:__default.section,"data-section":"welcome"},s("p",{className:__default.motto},"Have a better tab for this song?"),s("p",{className:__default.motto},"Care to fix the current tab?"),s("p",{className:__default.subMotto},"Submit your corrections for everyone to enjoy!"),s("div",{className:__default.auth,"aria-label":"auth"},"Please ",s($,{"data-link":"signin",to:"/a/wa/signin"},"sign up")," for free to submit a new revision.")),P=s("section",{className:__default.sectionForm,"data-section":"submit"},s("p",{className:__default.motto},"Have a better tab for this song?"),s("p",{className:__default.motto},"Care to fix the current tab?"),s("p",{className:__default.subMotto},"Submit your corrections for everyone to enjoy!"),s("div",{className:__default.actions},s("a",{id:"submit-revision-button",className:f.popupButtonGreen,onClick:()=>S(SubmitFormStates.SHOWN)},"Submit a new revision"))),V=s("section",{className:__default.sectionForm,"data-section":"submit"},s(UploadRevisionForm,{meta:k.current,actions:U})),G=s("section",{className:__default.section,"data-section":"duplicate"},s("p",{className:__default.motto,"aria-label":"motto"},"Submitted version already exists on Songsterr."),!H&&s("p",{className:__default.subMotto,"aria-label":"info"},"Uploaded file looks exactly like the latest version of this song."),H&&s("div",null,s("p",{className:__default.subMotto,"aria-label":"info"},"Uploaded file looks like a duplicate of ",s("br",null),s($,{to:E(w),"data-link":"duplicate"},j)))),W=s("section",{className:__default.section,"data-section":"success"},s("div",null,s("p",{className:__default.motto},"Thanks for contributing to Songsterr!"),s("p",{className:__default.subMotto},"We are processing the file and will redirect",s("br",null),"to a new revision as soon as possible."),s("div",null,s(L,{fill:"#fefefe",width:30,height:30})))),z=a((e,t)=>1===e.length||0!==t?{reportAction:null}:{reportAction:()=>{O.current&&(O.current.scrollTop=0),I||F(ReportFormStates.SHOWN),c("curiosity/event",{event:"Clicked on Report link"})}},[O,I]),X=s("section",{className:__default.sectionContent,"data-section":"revisions"},s("ul",{className:__default.list},_.revisions&&k.current&&_.revisions.map((e,t)=>s(RevisionItem,{revision:e,meta:k.current,partId:k.partId,key:e.revisionId,canDownloadRevisions:p.isLoggedIn,canManageRevisions:d(p,m.MANAGE_REVISIONS),locales:h.locale?[h.locale]:void 0,processing:R,...z(_.revisions,t)})))),q=!g&&!I,Q=g&&!B&&!I&&!y,Y=g&&!B&&!I&&!!y,Z=B&&!I&&!R,K=B&&!I&&R;return s(n,{},s("h3",{className:__default.title},D),s("div",{className:__default.scroller,ref:O},s("div",{className:__default.content,ref:A},q&&M,Q&&P,Y&&V,Z&&G,K&&W,g&&!!I&&s(RevisionReportForm,{meta:k.current,actions:T}),!g&&!!I&&s("section",{className:__default.section,"data-section":"welcome"},s("div",{className:__default.authReport,"aria-label":"auth"},"Please ",s($,{"data-link":"signin",to:"/a/wa/signin"},"sign up")," for free to report issues."),s("a",{className:f.popupButtonLinkOrange,onClick:()=>F(0)},"Back to revisions")),C&&!I&&s("div",{className:__default.spinner},s(L,{className:x.revisions,width:25,height:24,fill:"#f7f6ee"})),!C&&!I&&X)))};export{RevisionsPopupContent as default};
